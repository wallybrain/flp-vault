---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: [01, 02]
files_modified:
  - src-tauri/src/commands/scan.rs
  - src-tauri/src/commands/settings.rs
  - src-tauri/src/commands/browse.rs
  - src-tauri/src/commands/mod.rs
  - src-tauri/src/services/scanner.rs
  - src-tauri/src/services/mod.rs
  - src-tauri/src/main.rs
  - src/index.html
  - src/js/main.js
  - src/js/api.js
  - src/js/panels/scan-table.js
  - src/js/panels/settings-panel.js
  - src/styles/main.css
autonomous: true
requirements:
  - PARS-01
  - PARS-06
  - SETT-01
  - SETT-02
  - SETT-03

must_haves:
  truths:
    - "User can configure source, organized, and originals folder paths in a settings panel"
    - "Settings survive app restart (persisted in SQLite)"
    - "User can trigger a scan of the source folder"
    - "Scan results stream into a sortable table showing filename, BPM, channels, plugins, modified date"
    - "Re-scanning a folder with unchanged files is fast (cache hits skip re-parsing)"
    - "Scan shows progress bar with file count"
    - "Changing source folder in settings triggers automatic rescan"
    - "Empty state shows helpful message with link to settings"
  artifacts:
    - path: "src-tauri/src/commands/scan.rs"
      provides: "scan_folder and cancel_scan Tauri commands"
      exports: ["scan_folder", "cancel_scan"]
    - path: "src-tauri/src/commands/settings.rs"
      provides: "get_settings and save_settings Tauri commands"
      exports: ["get_settings", "save_settings"]
    - path: "src-tauri/src/commands/browse.rs"
      provides: "list_scanned_files command for the table"
      exports: ["list_scanned_files"]
    - path: "src-tauri/src/services/scanner.rs"
      provides: "Background scan logic with progress events"
      exports: ["run_scan"]
    - path: "src/js/panels/scan-table.js"
      provides: "Scan results table UI with sorting"
    - path: "src/js/panels/settings-panel.js"
      provides: "Settings slide-out panel with folder pickers"
  key_links:
    - from: "src/js/api.js"
      to: "src-tauri/src/commands/scan.rs"
      via: "invoke('scan_folder')"
      pattern: "invoke.*scan_folder"
    - from: "src/js/api.js"
      to: "src-tauri/src/commands/settings.rs"
      via: "invoke('get_settings') and invoke('save_settings')"
      pattern: "invoke.*settings"
    - from: "src/js/panels/scan-table.js"
      to: "src-tauri/src/commands/scan.rs"
      via: "listen('scan:progress') event handler"
      pattern: "listen.*scan:progress"
    - from: "src-tauri/src/services/scanner.rs"
      to: "src-tauri/src/parser/flp.rs"
      via: "parser::parse_flp(&bytes)"
      pattern: "parse_flp"
    - from: "src-tauri/src/services/scanner.rs"
      to: "src-tauri/src/store/files.rs"
      via: "store::is_cached() and store::upsert_file()"
      pattern: "is_cached|upsert_file"
---

<objective>
Wire the scan command, settings commands, and scan results frontend — the full vertical slice from "user configures a folder" to "user sees parsed .flp metadata in a table."

Purpose: Deliver the first user-visible capability: point the app at a folder, see all .flp files with their metadata. This proves the parser, cache, and IPC pipeline work end-to-end.
Output: Working scan workflow with settings panel, progress bar, and sortable results table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

<interfaces>
From Plan 01 (state.rs):
```rust
pub struct AppState {
    pub db: Arc<Mutex<Connection>>,
    pub scan_status: Mutex<ScanStatus>,
}
pub struct ScanStatus {
    pub total: usize,
    pub done: usize,
    pub running: bool,
}
```

From Plan 01 (store/files.rs):
```rust
pub fn is_cached(db: &Mutex<Connection>, path: &str, file_size: i64, mtime: i64) -> bool;
pub fn hash_in_cache(db: &Mutex<Connection>, hash: &str) -> bool;
pub fn update_path_index(db: &Mutex<Connection>, path: &str, hash: &str, file_size: i64, mtime: i64);
pub fn upsert_file(db: &Mutex<Connection>, hash: &str, path: &str, file_size: i64, mtime: i64, meta: &FlpMetadata);
pub fn list_all_files(db: &Mutex<Connection>) -> Vec<FileRecord>;
```

From Plan 01 (store/settings.rs):
```rust
pub fn get_all_settings(db: &Mutex<Connection>) -> Settings;
pub fn set_setting(db: &Mutex<Connection>, key: &str, value: &str);
```

From Plan 02 (parser/flp.rs):
```rust
pub fn parse_flp(bytes: &[u8]) -> Result<FlpMetadata, ParseError>;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Tauri commands and scanner service</name>
  <files>
    src-tauri/src/commands/scan.rs
    src-tauri/src/commands/settings.rs
    src-tauri/src/commands/browse.rs
    src-tauri/src/commands/mod.rs
    src-tauri/src/services/scanner.rs
    src-tauri/src/services/mod.rs
    src-tauri/src/main.rs
  </files>
  <action>
    **commands/scan.rs**: Implement `scan_folder(path: String, state: State<'_, AppState>, app_handle: AppHandle) -> Result<(), String>`. Clone db Arc and spawn `tokio::async_runtime::spawn` with `scanner::run_scan()`. Also implement `cancel_scan(state: State<'_, AppState>) -> Result<(), String>` that sets `scan_status.running = false`.

    **commands/settings.rs**: Implement `get_settings(state: State<'_, AppState>) -> Result<Settings, String>` that calls `store::settings::get_all_settings()`. Implement `save_settings(settings: Settings, state: State<'_, AppState>) -> Result<SettingsValidation, String>` that saves settings and returns validation warnings. `SettingsValidation` has `warnings: Vec<String>`. Validate: check if folders exist (warn if not), warn if source == organized, warn if source == originals.

    **commands/browse.rs**: Implement `list_scanned_files(state: State<'_, AppState>) -> Result<Vec<FileRecord>, String>` that calls `store::files::list_all_files()`.

    **commands/mod.rs**: Declare all command modules, re-export.

    **services/scanner.rs**: Implement `run_scan(path: &str, db: Arc<Mutex<Connection>>, app: AppHandle)`:
    1. Walk directory recursively with `walkdir::WalkDir`, filter for `.flp` extension
    2. Emit `scan:started` event with `{ total: N }`
    3. For each file: stat it, check `is_cached()` by path+mtime+size. If cached, emit progress and skip.
    4. If not cached: read file bytes, compute xxhash3 hash. Check `hash_in_cache()`. If hash known, update path_index only.
    5. If new content: call `parser::parse_flp(&bytes)`. On Ok, call `upsert_file()`. On Err, create a minimal FileRecord with warnings.
    6. Emit `scan:progress` event with `{ done, total, path, meta }` (meta is the parsed FlpMetadata serialized)
    7. After loop, emit `scan:complete` event with `{ total }`
    8. Check `scan_status.running` between files — if false, emit `scan:cancelled` and return early.

    For xxhash3: use `xxhash_rust::xxh3::xxh3_64(&bytes)` and format as hex string.

    **main.rs**: Update to register all commands in `generate_handler![]`: scan_folder, cancel_scan, get_settings, save_settings, list_scanned_files.

    **services/mod.rs**: Declare scanner module.
  </action>
  <verify>
    <automated>cd src-tauri && cargo check 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All 5 Tauri commands compile and are registered
    - Scanner walks directory, checks cache, parses uncached files, emits events
    - Settings validation warns on invalid folder configs
    - `cargo check` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Build scan results table and settings panel frontend</name>
  <files>
    src/index.html
    src/js/main.js
    src/js/api.js
    src/js/panels/scan-table.js
    src/js/panels/settings-panel.js
    src/styles/main.css
  </files>
  <action>
    **api.js**: Create invoke wrappers using `@tauri-apps/api/core` (invoke) and `@tauri-apps/api/event` (listen):
    - `scanFolder(path)` -> `invoke('scan_folder', { path })`
    - `cancelScan()` -> `invoke('cancel_scan')`
    - `getSettings()` -> `invoke('get_settings')`
    - `saveSettings(settings)` -> `invoke('save_settings', { settings })`
    - `listScannedFiles()` -> `invoke('list_scanned_files')`
    - `onScanStarted(callback)` -> `listen('scan:started', callback)`
    - `onScanProgress(callback)` -> `listen('scan:progress', callback)`
    - `onScanComplete(callback)` -> `listen('scan:complete', callback)`

    Import `@tauri-apps/api` from node_modules (npm installed in Plan 01). Use ES module imports. Tauri v2 frontend dist serves from the src/ directory — use relative paths in imports or configure the Tauri dev server.

    **scan-table.js**: Implement scan results table module:
    - Create dark-themed table with columns: Name, BPM, Channels, Plugins, Modified
    - All columns sortable (click header to toggle asc/desc, default sort by name)
    - Name column shows filename only (full path as title tooltip)
    - BPM column: show value or "?" for None with warning icon (title tooltip explains)
    - Channels column: show channel_count number
    - Plugins column: show first 2-3 plugin names, then "(+N more)" if truncated. Full list on hover (title attribute)
    - Modified column: format mtime as human-readable date
    - Progress bar at top: "Scanning... 142/873 files" with cancel button
    - Results stream into table as scan:progress events arrive (live accumulation)
    - Empty state: large centered "No .flp files found" with "Open Settings" button
    - Warning icon (yellow triangle or similar CSS indicator) on rows with parse warnings

    **settings-panel.js**: Implement slide-out settings panel:
    - Gear icon in top toolbar opens panel (slides from right)
    - Three folder settings: Source, Organized, Originals
    - Each has a read-only text display showing the current path and a "Browse..." button
    - "Browse..." button opens a native OS folder picker dialog using `@tauri-apps/plugin-dialog` (`open({ directory: true, title: "Select Source Folder" })`). Import `open` from `@tauri-apps/plugin-dialog`. When user selects a folder, update the display and the settings object.
    - Smart defaults shown as placeholder text when no folder is selected
    - Save button calls saveSettings(), displays any validation warnings
    - Changing source folder and saving triggers automatic rescan (frontend logic: if source_folder changed, call scanFolder after save)
    - Close button or click-outside to dismiss panel

    **main.js**: Initialize app:
    - On load, call getSettings(). If source_folder is set, call listScannedFiles() to populate table.
    - Set up event listeners for scan events
    - Wire gear icon to settings panel toggle
    - Handle empty state

    **index.html**: Update with:
    - Top toolbar with app name "FLP Vault", gear icon, scan button
    - Main content area for scan results table
    - Settings panel container (hidden by default)
    - Progress bar container (hidden by default)

    **main.css**: Dark theme styles:
    - Background: #1a1a2e, text: #e0e0e0
    - Table: dense rows, alternating row colors (#1a1a2e / #16213e), hover highlight
    - Header row: sortable with up/down arrows
    - Settings panel: slide-out from right, semi-transparent overlay
    - Progress bar: thin bar at top, blue fill (#4361ee)
    - Warning icon: yellow (#ffd166) unicode triangle or CSS
    - Inputs and buttons: dark theme matching
    - Responsive (table scrolls horizontally if needed)
    - Font: system-ui, -apple-system, sans-serif
    - Feel like a file manager: dense, scannable, functional
  </action>
  <verify>
    <automated>ls src/js/panels/scan-table.js src/js/panels/settings-panel.js src/js/api.js src/js/main.js && grep -q "scan_folder" src/js/api.js && grep -q "get_settings" src/js/api.js && grep -q "save_settings" src/js/api.js && grep -q "list_scanned_files" src/js/api.js && grep -q "scan:progress" src/js/panels/scan-table.js && grep -q "plugin-dialog" src/js/panels/settings-panel.js && echo "All frontend files exist and wiring verified"</automated>
  </verify>
  <done>
    - Scan results table renders with sortable columns
    - Settings panel slides out from gear icon
    - Progress bar shows during scan
    - Empty state displays when no files found
    - Source folder change triggers rescan
    - Dark theme applied throughout
    - All frontend files exist and are wired to Tauri commands
  </done>
</task>

</tasks>

<verification>
1. `cargo check` succeeds with all commands registered
2. All frontend JS files exist in correct locations
3. API wrappers match command signatures
4. Event names match between Rust emit and JS listen
5. Settings persistence round-trip: save -> restart -> load returns same values
</verification>

<success_criteria>
- Five Tauri commands registered and functional: scan_folder, cancel_scan, get_settings, save_settings, list_scanned_files
- Scanner walks directory, uses mtime+size cache shortcut, parses uncached files
- Scan emits progress events that stream into the results table
- Settings panel allows configuring three folder paths with validation warnings
- Changing source folder triggers automatic rescan
- Table shows filename, BPM, channels, plugins (truncated), modified date
- All columns sortable
- Empty state shows "No .flp files found" with settings link
- Dark theme throughout
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
