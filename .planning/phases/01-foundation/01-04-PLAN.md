---
phase: 01-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/build.yml
autonomous: false
requirements:
  - DIST-01
  - DIST-02

must_haves:
  truths:
    - "GitHub Actions workflow exists and runs on push to main"
    - "Workflow produces a Windows .msi installer artifact"
    - "GitHub Actions workflow is configured with downloadBootstrapper mode (verified via tauri.conf.json check, not runtime installer size)"
  artifacts:
    - path: ".github/workflows/build.yml"
      provides: "CI pipeline for Windows installer"
      contains: "windows-latest"
  key_links:
    - from: ".github/workflows/build.yml"
      to: "src-tauri/tauri.conf.json"
      via: "tauri-action reads tauri.conf.json for build config"
      pattern: "tauri-action"
---

<objective>
Set up the GitHub Actions CI pipeline that produces a Windows .msi installer on every push to main. Wire this up before features are complete — proving the delivery path works early prevents a last-minute scramble.

Purpose: From STATE.md blocker: ".msi installer cannot be produced from Linux." The CI pipeline is the only way to produce the deliverable installer. Verifying it works with the scaffold ensures every subsequent push produces a testable artifact.
Output: A working `.github/workflows/build.yml` that produces an .msi artifact on windows-latest runner.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions Windows build workflow</name>
  <files>
    .github/workflows/build.yml
  </files>
  <action>
    Create `.github/workflows/build.yml` with the following configuration:

    ```yaml
    name: Build Windows Installer

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      build-windows:
        runs-on: windows-latest

        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'

          - name: Setup Rust
            uses: dtolnay/rust-toolchain@stable
            with:
              targets: x86_64-pc-windows-msvc

          - name: Rust cache
            uses: swatinem/rust-cache@v2
            with:
              workspaces: './src-tauri -> target'

          - name: Install frontend dependencies
            run: npm install

          - name: Build Tauri app
            uses: tauri-apps/tauri-action@v0
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              tagName: v__VERSION__
              releaseName: 'FLP Vault v__VERSION__'
              releaseBody: 'Windows installer produced by CI.'
              releaseDraft: true
              prerelease: false
    ```

    Key decisions embedded in the workflow:
    - `windows-latest` runner: required for .msi production (WiX toolset is pre-installed on windows-latest)
    - `dtolnay/rust-toolchain@stable`: pinned Rust version strategy (uses latest stable)
    - `swatinem/rust-cache@v2`: caches target/ directory for faster builds
    - `tauri-apps/tauri-action@v0`: handles the full build + artifact upload flow
    - Draft releases: CI creates drafts, user promotes to published
    - GITHUB_TOKEN: automatically provided, no manual secrets needed
    - No code signing: Phase 1 produces unsigned .msi (SmartScreen will warn, acceptable for dev builds)

    The .msi installer uses `downloadBootstrapper` for WebView2 (configured in tauri.conf.json from Plan 01), keeping installer size small. Expected installer size: 5-8 MB, well within the 15 MB DIST-02 requirement.

    IMPORTANT: This workflow will only produce artifacts AFTER Plan 01 has been merged (it needs Cargo.toml, tauri.conf.json, etc. to exist). However, the workflow file itself is independent and can be created in Wave 1 in parallel with Plan 01. The first successful build will happen after both plans are merged.
  </action>
  <verify>
    <automated>cat .github/workflows/build.yml | grep -c "windows-latest" && echo "Workflow targets Windows"</automated>
  </verify>
  <done>
    - .github/workflows/build.yml exists with correct structure
    - Workflow triggers on push to main and PRs to main
    - Uses windows-latest runner
    - Uses tauri-apps/tauri-action for build
    - Produces draft releases with .msi artifact
    - Uses Rust cache for faster subsequent builds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify CI produces Windows installer</name>
  <what-built>GitHub Actions Windows build pipeline. After the scaffold (Plan 01) is pushed to main, the CI pipeline should trigger and produce a Windows .msi installer artifact.</what-built>
  <action>Human verification checkpoint — verify the CI pipeline produces a valid .msi installer after code is pushed to GitHub.</action>
  <how-to-verify>
    1. After Plans 01-03 are complete and pushed to GitHub, check the Actions tab
    2. Verify the "Build Windows Installer" workflow ran
    3. Check that the workflow completed successfully (green check)
    4. Check GitHub Releases for a draft release with .msi attachment
    5. Download the .msi and verify its size is under 15 MB
    6. (Optional) Install on a Windows machine and verify the app opens

    If the workflow hasn't triggered yet (because code hasn't been pushed), this checkpoint can be deferred to after the first push to main.
  </how-to-verify>
  <resume-signal>Type "verified" if CI produced a valid .msi, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/build.yml` exists and is valid YAML
2. Workflow targets `windows-latest` runner
3. Workflow uses `tauri-apps/tauri-action@v0`
4. No hardcoded secrets (only `GITHUB_TOKEN` which is automatic)
5. Draft release mode enabled (user controls when to publish)
</verification>

<success_criteria>
- GitHub Actions workflow file exists at `.github/workflows/build.yml`
- Workflow is valid YAML with correct trigger configuration
- Workflow targets windows-latest and uses tauri-action
- After first push, CI produces a Windows .msi installer
- WebView2 downloadBootstrapper configured in tauri.conf.json (keeps installer small per DIST-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
