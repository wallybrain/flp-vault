---
phase: 02-grouping
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/js/workflow/review-panel.js
  - src/js/main.js
  - src/js/api.js
  - src/styles/main.css
  - src/index.html
autonomous: true
requirements:
  - GRUP-05
  - GRUP-06
  - GRUP-07
  - GRUP-08
  - GRUP-09

must_haves:
  truths:
    - "After scan completes, a 'Review Groups' button appears that triggers group proposal computation"
    - "Review panel displays group proposals sorted by confidence ascending (hardest first)"
    - "User can merge two groups into one"
    - "User can split files out of a group into a new group"
    - "User can rename a group's canonical name inline"
    - "User can assign ungrouped files to an existing group"
    - "User can mark individual files as ignored"
    - "'Approve All High Confidence' batch action confirms all groups with confidence >= 0.85"
    - "Closing the app with unsaved edits shows a confirmation warning"
    - "All review edits are in-memory only — no files are copied or moved"
  artifacts:
    - path: "src/js/workflow/review-panel.js"
      provides: "Group review UI with merge/split/rename/assign/ignore actions"
      min_lines: 200
    - path: "src/js/api.js"
      provides: "invoke wrappers for propose_groups and confirm_groups"
      contains: "propose_groups"
    - path: "src/styles/main.css"
      provides: "Review panel styles with confidence color coding"
      contains: "review-panel"
  key_links:
    - from: "src/js/workflow/review-panel.js"
      to: "src/js/api.js"
      via: "proposeGroups() and confirmGroups() invoke wrappers"
      pattern: "proposeGroups|confirmGroups"
    - from: "src/js/main.js"
      to: "src/js/workflow/review-panel.js"
      via: "import and init after scan completes"
      pattern: "review.*init|reviewPanel"
---

<objective>
Build the frontend review UI that displays group proposals sorted by confidence (lowest first), and provides merge, split, rename, assign, and ignore actions. All edits are held in JS memory until final batch confirmation.

Purpose: The review step is the critical human-in-the-loop gate — no files are organized until the user confirms groups. The UI must surface low-confidence proposals first (they need the most attention) and provide efficient batch actions for high-confidence groups.
Output: A working `review-panel.js` module wired into the existing main.js flow, with API wrappers for propose_groups and confirm_groups commands.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-grouping/02-RESEARCH.md
@.planning/phases/02-grouping/02-01-SUMMARY.md

<interfaces>
<!-- ProposedGroup shape returned by propose_groups Tauri command -->
```rust
pub struct ProposedGroup {
    pub id: String,               // UUID v4
    pub canonical_name: String,   // normalized name, user-editable
    pub confidence: f32,          // 0.0-1.0, minimum edge in group
    pub file_hashes: Vec<String>, // all files in this group
    pub is_ungrouped: bool,       // true if single-file no-match proposal
}
```

<!-- GroupConfirmation input for confirm_groups Tauri command -->
```rust
pub struct GroupConfirmation {
    pub canonical_name: String,
    pub file_hashes: Vec<String>,
    pub ignored_hashes: Vec<String>,
}
```

<!-- Existing API wrappers from Phase 1 (src/js/api.js) -->
```javascript
// Pattern: const { invoke } = window.__TAURI__.core;
export async function scanFolder(path) { ... }
export async function cancelScan() { ... }
export async function getSettings() { ... }
export async function saveSettings(settings) { ... }
export async function listScannedFiles() { ... }
```

<!-- Existing scan-table.js exports a render function and emits events -->
<!-- main.js wires DOMContentLoaded and Tauri event listeners -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review-panel.js with group display, pagination, and confidence coloring</name>
  <files>
    src/js/workflow/review-panel.js
    src/js/api.js
    src/styles/main.css
    src/index.html
  </files>
  <action>
    **src/js/api.js**: Add two new invoke wrappers alongside existing ones:
    ```javascript
    export async function proposeGroups() {
      return await invoke('propose_groups');
    }
    export async function confirmGroups(groups) {
      return await invoke('confirm_groups', { groups });
    }
    export async function listGroups() {
      return await invoke('list_groups');
    }
    export async function resetGroups() {
      return await invoke('reset_groups');
    }
    ```

    **src/index.html**: Add a "Review Groups" button inside the toolbar area (alongside existing scan button). Also add a `#review-container` div inside `#main-content` (hidden by default).
    ```html
    <button id="btn-review-groups" class="toolbar-btn" style="display:none;">Review Groups</button>
    <div id="review-container" class="review-panel" style="display:none;"></div>
    ```

    **src/js/workflow/review-panel.js**: Create new module. Use the same DOM construction patterns as scan-table.js (makeEl + textContent, no innerHTML).

    Module state:
    ```javascript
    let proposals = [];          // Vec<ProposedGroup> from invoke
    let ignoredHashes = new Set();
    let currentPage = 0;
    const PAGE_SIZE = 20;
    let fileDetailsMap = {};     // hash -> {path, bpm, mtime} from listScannedFiles
    ```

    Core functions:
    - `export async function init(container)` — fetch proposals via `proposeGroups()`, fetch file details via `listScannedFiles()` to populate fileDetailsMap, render first page
    - `export function show()` / `export function hide()` — toggle visibility
    - `renderPage(page)` — render up to PAGE_SIZE groups for current page
    - `renderGroupCard(group, index)` — single group card with:
      - Header: "Group N of M — Confidence: XX% (LOW/MEDIUM/HIGH)"
      - Confidence label colors: < 0.65 = `#ff4444` (LOW), 0.65-0.84 = `#ffaa00` (MEDIUM), >= 0.85 = `#44ff44` (HIGH)
      - Editable canonical name field (text input, blur/Enter to commit)
      - File table: filename (from path), BPM, date (from mtime), with per-file "Ignore" button
      - Action buttons: [Split] [Merge with...] [Assign file to this group]

    Pagination:
    - Show "Group X-Y of Z" counter
    - Previous/Next page buttons
    - "Approve All High Confidence" button in header — confirm all groups with confidence >= 0.85 in one action, show count: "Approve N high-confidence groups"

    Footer:
    - "Confirm All Groups" button — calls confirmGroups() with final state
    - "Cancel Review" button — returns to scan table view

    **Confidence color coding CSS** (add to src/styles/main.css):
    ```css
    .review-panel { padding: 1rem; }
    .group-card {
      background: var(--surface, #2a2a3e);
      border: 1px solid var(--border, #3a3a5e);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .confidence-low { color: #ff4444; }
    .confidence-medium { color: #ffaa00; }
    .confidence-high { color: #44ff44; }
    .group-card .canonical-input {
      background: var(--input-bg, #1a1a2e);
      color: var(--text, #e0e0e0);
      border: 1px solid var(--border, #3a3a5e);
      padding: 0.3rem 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
    }
    .group-card .file-table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
    .group-card .file-table td { padding: 0.3rem 0.5rem; }
    .ungrouped-section { border-top: 2px dashed var(--border, #3a3a5e); margin-top: 1.5rem; padding-top: 1rem; }
    .ignored-file { opacity: 0.4; text-decoration: line-through; }
    .btn-approve-all { background: #2d5a2d; color: #44ff44; }
    .btn-confirm-all { background: #1a5a8a; color: #e0e0e0; }
    ```

    **IMPORTANT non-destructive guarantee**: The review panel NEVER calls any file copy/move operation. It only reads (proposeGroups, listScannedFiles) and writes groups (confirmGroups). All merge/split/rename/assign/ignore operations mutate the in-memory `proposals` array only.
  </action>
  <verify>
    <automated>test -f /home/lwb3/flp-vault/src/js/workflow/review-panel.js && grep -c "proposeGroups\|confirmGroups\|renderGroupCard\|renderPage" /home/lwb3/flp-vault/src/js/workflow/review-panel.js</automated>
  </verify>
  <done>
    - review-panel.js exists with init/show/hide exports
    - Proposals displayed as group cards with confidence color coding
    - Pagination works (PAGE_SIZE = 20)
    - Canonical name is editable inline
    - File table shows filename, BPM, date for each file in group
    - "Approve All High Confidence" button in header
    - "Confirm All Groups" and "Cancel Review" buttons in footer
    - api.js has proposeGroups, confirmGroups, listGroups, resetGroups wrappers
    - CSS styles for review panel, group cards, confidence colors
    - index.html has review button and container
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement merge, split, assign, ignore actions and wire review flow into main.js</name>
  <files>
    src/js/workflow/review-panel.js
    src/js/main.js
  </files>
  <action>
    **Add action handlers to review-panel.js:**

    **Merge (GRUP-05)**: When user clicks "Merge with..." on a group card:
    1. Show a dropdown/modal listing all other group canonical names (searchable if > 10 groups)
    2. On selection: combine file_hashes from both groups, set confidence to the lower of the two
    3. Remove the merged-from group from proposals array
    4. Re-render current page

    **Split (GRUP-06)**: When user clicks "Split" on a group card:
    1. Show checkboxes next to each file in the group
    2. User checks files to split out, clicks "Confirm Split"
    3. Create new ProposedGroup with checked files (generate new UUID via crypto.randomUUID())
    4. Remove checked files from original group
    5. New group gets is_ungrouped=false, confidence=0.0 (manually created)
    6. Re-render

    **Assign ungrouped (GRUP-08)**: Ungrouped files section at bottom of review. Each ungrouped file has "Assign to..." dropdown listing all named groups. On selection:
    1. Add file hash to target group's file_hashes
    2. Remove the ungrouped singleton from proposals
    3. Re-render

    **Ignore (GRUP-09)**: Per-file "Ignore" button within group cards:
    1. Add hash to ignoredHashes set
    2. Visually mark file with .ignored-file class (strikethrough, opacity 0.4)
    3. If all files in a group are ignored, mark the entire group as ignored (gray out card)
    4. "Ignored Files" collapsible section at bottom shows all ignored files with "Un-ignore" button

    **Rename (GRUP-07)**: Already handled by the inline editable canonical name field from Task 1. On blur or Enter:
    1. Update the group's canonical_name in the proposals array
    2. No re-render needed (input already shows new value)

    **Confirm All Groups button handler:**
    1. Build `Vec<GroupConfirmation>` from proposals: for each non-ignored group, create `{canonical_name, file_hashes (excluding ignored), ignored_hashes (from ignoredHashes set intersected with group's files)}`
    2. Call `confirmGroups(confirmations)`
    3. On success: show success message, hide review panel, return to scan table
    4. On error: show error message, stay on review panel

    **Wire into main.js:**
    1. Import review-panel module
    2. After scan completes (listen for scan-complete event or check scan status), show the "Review Groups" button
    3. On "Review Groups" click: hide scan table, call `reviewPanel.init(document.getElementById('review-container'))`, show review container
    4. On "Cancel Review" or after successful confirmation: hide review container, show scan table

    **Close guard:** Register Tauri `onCloseRequested` event listener. If review panel is visible and proposals have been modified (any merge/split/rename/assign/ignore performed), show confirm dialog: "You have unsaved group edits. Close without saving?" If user cancels, prevent close.
    ```javascript
    import { getCurrentWindow } from '@tauri-apps/api/window';
    getCurrentWindow().onCloseRequested(async (event) => {
      if (reviewPanel.hasUnsavedEdits()) {
        const confirmed = await confirm('You have unsaved group edits. Close without saving?');
        if (!confirmed) event.preventDefault();
      }
    });
    ```

    Note: The `confirm()` here can use the browser's built-in confirm dialog or `@tauri-apps/plugin-dialog`'s `confirm()`. The browser's native confirm is simpler and sufficient for this purpose.
  </action>
  <verify>
    <automated>grep -c "merge\|split\|assign\|ignore\|rename\|confirmGroups\|hasUnsavedEdits" /home/lwb3/flp-vault/src/js/workflow/review-panel.js && grep -c "review" /home/lwb3/flp-vault/src/js/main.js</automated>
  </verify>
  <done>
    - Merge action combines two groups with lower confidence
    - Split action creates new group from selected files
    - Assign action moves ungrouped file to existing group
    - Ignore action marks file with strikethrough and adds to ignoredHashes
    - Un-ignore action restores file
    - Rename commits on blur/Enter
    - "Confirm All Groups" builds GroupConfirmation array and calls confirmGroups
    - "Approve All High Confidence" batch confirms groups >= 0.85 confidence
    - main.js shows review button after scan, wires panel lifecycle
    - Close guard warns about unsaved edits
    - No file copy/move operations exist in review panel code
  </done>
</task>

</tasks>

<verification>
1. `review-panel.js` exists in `src/js/workflow/` with init/show/hide exports
2. All 5 actions present: merge, split, rename, assign, ignore (grep confirms)
3. `api.js` has proposeGroups and confirmGroups wrappers
4. `main.js` imports and wires review panel
5. CSS contains review-panel styles with confidence color classes
6. No innerHTML usage (security: all DOM built with createElement/textContent)
7. No file copy/move/write operations in review-panel.js (non-destructive guarantee)
</verification>

<success_criteria>
- Review panel renders group proposals sorted by confidence ascending
- Confidence color coding: LOW (red), MEDIUM (yellow), HIGH (green)
- Pagination with 20 groups per page
- All 5 GRUP actions work: merge, split, rename, assign, ignore
- "Approve All High Confidence" batch action works
- "Confirm All Groups" sends final state to backend
- Close guard prevents accidental data loss
- All operations are in-memory only until final confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/02-grouping/02-02-SUMMARY.md`
</output>
